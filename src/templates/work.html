<html>
  <head> </head>
  <body>
    内容はないよう。 開発者ツールのネットワークを見てね。
  </body>
  <br>
  <button id="button-twitter-create">oauth twitter create</button>
  <button id="button-twitter-login">oauth twitter login</button>
  <br>
  <button id="button-google-create">oauth google create</button>
  <button id="button-google-login">oauth google login</button>
  <br>
  <button id="button-logout">logout</button>
</html>

<script>
  // logout
  document.getElementById("button-logout").onclick = function() {
    const data = {};
    const param  = {
      method: "POST",
      headers: {
        "Content-Type": "application/json; charset=utf-8"
      },
      body: JSON.stringify(data)
    };
    fetch(clinetOrigin + '/users/logout', param)
    .then((res)=>{
      return( res.json() );
    })
    .then((data)=>{
      console.log('logout owata');
    });
  };

  // twitter 新規登録
  document.getElementById("button-twitter-create").onclick = function() {
    localStorage.setItem("OAUTH_PROVIDER", 'twitter')
    localStorage.setItem("OAUTH_MODE", 'create')
    // ■GET
    fetch(clinetOrigin + "/oauth/twitter/url")
    .then((response) => response.json())
    .then((data) => {
      console.log("Success fetch-token:", data)
      location.href=data.url;
    })
    .catch((error) => {
      console.error("Error:", error)
    })
  };

  // twitter ログイン
  document.getElementById("button-twitter-login").onclick = function() {
    localStorage.setItem("OAUTH_PROVIDER", 'twitter')
    localStorage.setItem("OAUTH_MODE", 'login')
    // ■GET
    fetch(clinetOrigin + "/oauth/twitter/url")
    .then((response) => response.json())
    .then((data) => {
      console.log("Success fetch-token:", data)
      location.href=data.url;
    })
    .catch((error) => {
      console.error("Error:", error)
    })
  }; 

  // google 新規登録
  document.getElementById("button-google-create").onclick = function() {
    localStorage.setItem("OAUTH_PROVIDER", 'google')
    localStorage.setItem("OAUTH_MODE", 'create')
    // ■GET
    fetch(clinetOrigin + "/oauth/google/url")
    .then((response) => response.json())
    .then((data) => {
      console.log("Success fetch-token:", data)
      location.href=data.url;
    })
    .catch((error) => {
      console.error("Error:", error)
    })
  };

  // google ログイン
  document.getElementById("button-google-login").onclick = function() {
    localStorage.setItem("OAUTH_PROVIDER", 'google')
    localStorage.setItem("OAUTH_MODE", 'login')
    // ■GET
    fetch(clinetOrigin + "/oauth/google/url")
    .then((response) => response.json())
    .then((data) => {
      console.log("Success fetch-token:", data)
      location.href=data.url;
    })
    .catch((error) => {
      console.error("Error:", error)
    })
  }; 

  // localhost or ipだと何故かクッキー送信できないのでhostでフォワーディングする事
  serverOrigin = "http://server.test.com:3000"
  clinetOrigin = "https://df6e-2400-2200-622-b4b8-41f2-2585-d918-4047.jp.ngrok.io/"

  const code = getParam("code", window.location.href)
  if(code){
    // ■GET
    fetch(clinetOrigin + "/twitter/fetch-token?code=" + encodeURIComponent(code))
    .then((response) => response.json())
    .then((data) => {
      console.log("Success fetch-token:", data)
      fetch(clinetOrigin + "/twitter/get-user-info?token=" + data.token)
      .then((response) => response.json())
      .then((data) => {
        console.log("Success get-user-info:", data)
      })
    })
    .catch((error) => {
      console.error("Error:", error)
    })
  }

  function getParam(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}
</script>
